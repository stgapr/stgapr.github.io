<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    
    <meta name="keywords" content="Life, Tech, Galgame, Anime, Manga, Programming, Harmonica, Novel, Guitar, Cooking">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="水与榕" type="application/atom+xml">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/css/page.css">
<link rel="stylesheet" type="text/css" href="/css/post.css">

    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    <script defer src="/js/busuanzi.pure.mini.js"></script>
    
    
    <script defer type="text/javascript" src="/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>在ARM设备上“原生”运行windows游戏 | 水与榕</title>
  </head>
  <body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN" data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">水与榕</a></h1>
        <h2 class="subtitle"></h2>
      </div>
      
    </div>
    <nav id="nav" class="nav">
      <a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="Toggle Navbar"></i></a>
      <ul id="menu" role="menubar" aria-hidden="false">
        
        <li role="menuitem"><a href="/">Home</a></li>
        
        <li role="menuitem"><a href="/archives/">Archives</a></li>
        
        <li role="menuitem"><a href="/categories/">Categories</a></li>
        
        <li role="menuitem"><a href="/tags/">Tags</a></li>
        
        <li role="menuitem"><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            
<div id="post" class="page">
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="https://stgapr.github.io/post/galgame-on-ARM/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
       <meta itemprop="name" content="Prism(walnuss)">
       <meta itemprop="description" content>
       <meta itemprop="image" content="/images/avatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
       <meta itemprop="name" content="水与榕">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">在ARM设备上“原生”运行windows游戏</h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2021-07-17T09:01:04+08:00">2021-07-17 09:01:04</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/笔记/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      <p>单位最近在换国产机，虽然之前也换过一批X86架构的兆芯台式机（还tm装了Ghost Win7），但这一批是飞腾（ARM架构）的。没法直接装Windows（Windows11 on ARM另说）。 本着Galgame everywhere的原则，我想让这批机器也能跑windows上的galgame，于是边学边摸索除了一条未曾设想的道路。不是用远程桌面、虚拟机，也不是kirikiroid。  </p>
<p>这篇文章还没大写完，后面会加一些实际运行的配图。总之感谢<a href="https://noodlefighter.com" target="_blank" rel="noopener">@虾包</a> 的技术支持。</p>
<a id="more"></a>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>其实在ARM设备上打黄油的想法去年尝试过，当时的设备是一个性能不怎么样（Amlogic S905）的机顶盒Phicomm N1。在ARM设备上玩galgame有两个困难，在没有引擎移植（像是ons、pymo、kirikiroid）的前提下，你要在ARM芯片上执行exe，一面对着不同的处理器指令架构，一个是系统API都不一样。——虽然虽然跑虚拟机可以做到处理器级别的仿真，但那性能太差。</p>
<p>先说想到的第一个方案，Wine。Wine的原理是把Windows API用POSIX 实现了一遍，然后让（兼容POSIX标准的）宿主系统去执行。虽然Wine也最近除了X86版本的release，也提供了ARM版本的，连Android的ARM或X86架构的 release都有。但是！！—ARM release的只能跑ARM的程序（编译到ARM上的exe很少，一般都只提供target到X86的），X86 release的只能跑X86的程序。</p>
<p>不过之前微博上看到M$核心程序员兼女装大佬Tlaster买了台特别昂贵的笔记本Surface Pro X，跑传说中的Windows on ARM系统。她晒了一张图：</p>
<p><img src="//stgapr.github.io/post/galgame-on-ARM/tsukiyori_SQ1.PNG" alt="在ARM架构的SQ1芯片上跑X86程序"></p>
<p>这款笔记本跑的是高通定制的ARM架构的SQ1处理器。而黄油厂商我还没听说过技术先进到提供ARM platform  target的Galgame。也就是说这个版本的Windows 在二进制层面实现了一个X86到ARM的指令转换。不需要X86 EXE作任何修改、远非几年前的Windows RT能做得到的。</p>
<p>而前两天单位开始大规模换用飞腾 FT2000-A CPU（AArch）的台式机，不准用X86 Intel CPU+Windows了。现在终于有了这个上班摸鱼打黄油的需求（</p>
<p><img src="//stgapr.github.io/post/galgame-on-ARM/sysinfo.png" alt></p>
<h1 id="可行性和方案"><a href="#可行性和方案" class="headerlink" title="可行性和方案"></a>可行性和方案</h1><p>首先看看有没有人已经做了这件事。我去查了<a href="https://docs.microsoft.com/en-us/windows/arm/" target="_blank" rel="noopener">Windows Documentation</a>SDN上查了一下原理。发现类似64位windows兼容32位windows程序的途径——用<a href="https://docs.microsoft.com/en-us/windows/win32/winprog64/running-32-bit-applications" target="_blank" rel="noopener">WoW64层</a>，并且缓存这些已翻译的代码块，以减少指令翻译的开销，并在代码再次运行时进行优化。<br>所以Windows10 on ARM的windows目录里面，加上原本的X86_64和X86_32兼容设施——至少有三套system文件夹，啊不，实际上是四套：</p>
<p><strong>System32</strong>: ARM 64 位系统文件</p>
<p><strong>SyCHPE32</strong>： CHPE DLL，供 x86 程序调用，内部是 ARM 机器码（使得核心系统库不需要进行二进制翻译，减少性能损失)</p>
<p><strong>SysARM32</strong>: ARM 32 位系统文件</p>
<p><strong>SysWOW64</strong>: x86 32 位系统文件</p>
<p>其中给ARM处理器做X86指令的二进制翻译的关键DLL是<a href="https://docs.microsoft.com/en-us/windows/win32/winprog64/wow64-implementation-details" target="_blank" rel="noopener">xtajit.dll</a>。并且官方说这个DLL里面的转换函数巨复杂巨长，毕竟两种架构的CPU指令集完全不一样。根据爱好者测试，X86程序在ARM处理器上的翻译执行效率大概能达到原生的60%左右。WineHQ社区估计一时半会儿也没有精力重复造轮子（一是净室原则，二是Intel反复敲打版权警告）。</p>
<p>如<a href="https://wiki.winehq.org/Emulation" target="_blank" rel="noopener">WineHQ的这篇wiki</a>所说，想实现ARM平台跑X86程序（先不说操作系统），大概有三种曲线救国的途径：</p>
<ul>
<li><p>处理器模拟。也就是异构模拟。最省事，也最慢。也就是用QEMU、virtualbox之类的虚拟机软件模拟整个X86 CPU，上面再装一个X86的操作系统。Bluestack、Windroy等都是一个原理。</p>
</li>
<li><p>用户模式模拟。也就是用QEMU user space emulator之类的用户态X86仿真程序，在syscall级别jump out。效率稍微好一点。有的人可能玩过一些基于chroot或者proot——在安卓手机上跑Linux的<a href="https://github.com/meefik/linuxdeploy" target="_blank" rel="noopener">deploylinux</a>和Anlinux。优点是可以利用宿主的Linux内核，不需要再整一套镜像（因此，假如要跑windows exe，还需要配合X86版本的wine）。代表项目<a href="https://github.com/ptitSeb/box86" target="_blank" rel="noopener">box86</a></p>
</li>
<li><p>在操作系统API层面的仿真。和用户模式模拟类似，但更快一点。代表项目如<a href="https://github.com/AndreRH/hangover" target="_blank" rel="noopener">hangover</a>（宿醉。这名字起的……）。</p>
<p>有人可能会提起ExGear，但是：</p>
</li>
</ul>
<blockquote>
<p>A solution that I explored already in the past was ExaGear, which allowed running of x86 applications on ARM by emulating the CPU instructions, but not the entire PC.</p>
<p>Well ExaGear, although quite good, had one very big flaw: it was running everything in the i386 (x86) environment, which also is the case for the GPU drivers, which limited the the software only for use with applications that did not require 3D acceleration. Basically, any game that used “modern” graphics did not work, since it required OpenGL, which our ODROIDs lack the necessary drivers for and especially not for i386.</p>
</blockquote>
<p>于是工具落在了hangover和box86两者之间。</p>
<h2 id="hangover-和box86"><a href="#hangover-和box86" class="headerlink" title="hangover 和box86"></a>hangover 和box86</h2><p>hangover有一个缺点，它要靠QEMU做X86到ARM指令的转换，而且假如要用Wine也必须是64位的。hangover的开发方向主要是在64位平台（AArch64，X86_64）上跑64位程序，只是顺便兼容32位。</p>
<p>而box86目前只兼容X86_32（<strong>它不支持64位用户程序</strong>），用的X86 emulator是<a href="https://github.com/wfeldt/libx86emu" target="_blank" rel="noopener">libx86emu</a>的修改版。并且据官方readme文档所言，“box86 uses the native versions of some “system” libraries, like libc, libm, SDL, and OpenGL, it’s easy to integrate and use, and performance can be surprisingly high in some cases.”  </p>
<blockquote>
<p>应用程序所需的许多库都从ARM板重定向到了库，比如说Box86可以从ARM主机系统使用SDL2，而不是使用i386的SDL2。这也包括GPU驱动程序。如果应用程序需要运行OpenGL，它将不再要求i386 OpenGL驱动程序，而是ARM OpenGL驱动程序。还有许多其他库，例如SDL，OpenAL，X11等，也可以从本机ARM环境中使用，而不是使用i386中的所有库。这也意味着与需要完整i386环境的ExaGear相比，i386中需要的库要少得多。</p>
</blockquote>
<p>box86好像相当成熟，甚至已经基于该项目做了一个retro gaming向的<a href="https://twisteros.com/" target="_blank" rel="noopener">树莓派系统Twister OS（原名Raspbian X）</a>。</p>
<p>那我就选择box86来折腾了。我和去年相比，手头多了台性能好得多的ARM笔记本。</p>
<h2 id="构建box86"><a href="#构建box86" class="headerlink" title="构建box86"></a>构建box86</h2><p>其实网络上也有人<a href="https://github.com/SpacingBat3/box86-releases" target="_blank" rel="noopener">发布了Appimage格式的打包好的box86</a>，退一步<a href="https://github.com/Itai-Nelken/box86-2deb-weekly-script" target="_blank" rel="noopener">还有weekly自动构建脚本</a>但你要最新的构建的话，还是建议从挤牛奶和养鸡开始做蛋糕。</p>
<h3 id="关于ARM的架构"><a href="#关于ARM的架构" class="headerlink" title="关于ARM的架构"></a>关于ARM的架构</h3><blockquote>
<p>You <em>NEED</em> a 32-bit subsystem to run and build box86. box86 is useless on 64-bit only systems. Also, you <em>NEED</em> a 32-bit toolchain to build box86. A toolchain that only support 64-bit will not compile box86, and you’ll get errors (typically on aarch64, you get “-marm” not recognized).</p>
</blockquote>
<p>意思很明白：因为box86的原理是直接把X86_32代码转译到主机系统平台。要在（例如）ARM64平台上运行box86，需要为32位ARM构建box86，并且还需要具有32位库的chroot。重复一遍，<strong>box86不包含任何32位到64位的转换。</strong>当然我们在X86机器上交叉编译（比如编译到32位的ARM时）时，要提供一个32位的工具链。我们可以用著名的第三方工具链全家桶Linaro。</p>
<ul>
<li>假如是X86 CPU（不管32位还是64位）：需要交叉编译。（如果是windows，还得用mingw或cygwin）</li>
<li>假如是ARM （32位）CPU：直接编译</li>
<li>假如是ARM（64位）CPU：需要交叉编译，或者想办法chroot到32位环境里（见下文）。</li>
</ul>
<h3 id="换软件源（可选）"><a href="#换软件源（可选）" class="headerlink" title="换软件源（可选）"></a>换软件源（可选）</h3><p>这是在中国国内用户的必经之路。你不换国内的软件源镜像的话，每apt-get update一次就要花二十分钟，改个系统语言都下不到语言包。Debian/Ubuntu的apt源默认服务器在欧洲，到国内速度很慢，需要替换成国内的源才能正常安装一些软件。这一步依据自己实际的发行版修改软件源，切不可照抄，否则整个系统的包依赖关系都会炸！</p>
<p>以armbian为例。首先确认自己下载的armbian基于的 Linux 发行版（有的是Ubuntu，有的是Debian），这个在下载镜像的时候会在文件名里标注。在armbian登陆时的欢迎信息中也会显示，例如：</p>
<blockquote>
<p>Welcome to ARMBIAN 5.77 user-built Ubuntu 18.04.2 LTS 5.0.2-aml-s905</p>
</blockquote>
<p>我们找一个支持armbian的镜像源。清华源在我这里有问题会被阻断，我最后选择了USTC：</p>
<figure class="hljs highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/apt/sources.<span class="built_in">list</span></span><br></pre></td></tr></table></figure>
<p>假如你的armbian是基于debian 9(stretch)的，修改为：</p>
<figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">deb</span> [ arch=arm64,armhf ] http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian/ stretch main contrib non-free</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian/ stretch main contrib non-free</span><br><span class="line"><span class="keyword">deb</span> [ arch=arm64,armhf ] http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian/ stretch-updates main contrib non-free</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian/ stretch-updates main contrib non-free</span><br><span class="line"><span class="keyword">deb</span> [ arch=arm64,armhf ] http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian/ stretch-backports main contrib non-free</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian/ stretch-backports main contrib non-free</span><br><span class="line"><span class="keyword">deb</span> [ arch=arm64,armhf ] http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian-security/ stretch/updates main contrib non-free</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian-security/ stretch/updates main contrib non-free</span><br><span class="line"><span class="keyword">deb</span> [ arch=arm64,armhf ] http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/debian/ sid main contrib non-free</span><br></pre></td></tr></table></figure>
<p>假如是基于ubuntu 18.04 (bionic)的，修改为：</p>
<figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">deb</span> http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic main restricted universe multiverse</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic main restricted universe multiverse</span><br><span class="line"><span class="keyword">deb</span> http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic-security main restricted universe multiverse</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic-security main restricted universe multiverse</span><br><span class="line"><span class="keyword">deb</span> http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic-updates main restricted universe multiverse</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic-updates main restricted universe multiverse</span><br><span class="line"><span class="keyword">deb</span> http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic-backports main restricted universe multiverse</span><br><span class="line">#deb-src http<span class="variable">s:</span>//mirrors.ustc.edu.<span class="keyword">cn</span>/ubuntu-ports/ bionic-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure>
<p>上面把源代码(src)的port注释掉是因为性能一般的ARM CPU也没力气编译代码，二进制源应该够用了。<br>注意，这里给出的是Ubuntu bionic（18.04）和Debian stretch（9.0）的情况，请自行对照Debian/Ubuntu代号修改。比如Ubuntu Eoan（19.10）就要把上面的bionic字样改成eoan。</p>
<p>然后通过armbian-config把网络连上。网络环境不支持IPV6的要把IPV6支持关掉。刷新仓库目录并且更新软件包</p>
<figure class="hljs highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> update</span><br><span class="line">sudo apt-<span class="builtin-name">get</span> upgrade</span><br></pre></td></tr></table></figure>
<p>顺便一提，Armbian 默认只支持Aarch64架构。可以通过下列命令查看：</p>
<figure class="hljs highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg <span class="comment">--print-architecture</span></span><br><span class="line">dpkg <span class="comment">--print-foreign-architectures</span></span><br></pre></td></tr></table></figure>
<p>前者应该会显示arm64，后者应该会显示armhf。假如没有的话：</p>
<p>增加架构（我不确定这一步会带来什么影响）</p>
<figure class="hljs highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --add-architecture armhf</span><br><span class="line">sudo apt-<span class="builtin-name">get</span> update</span><br><span class="line">sudo apt-<span class="builtin-name">get</span> upgrade</span><br></pre></td></tr></table></figure>
<p>此外可以设置一下SSH、VNC/xrdp、调好wifi驱动(略），顺便解决armbian里面中文显示异常的bug:</p>
<p>此问题无法通过sudo dpkg-reconfigure locales、armbian-config或者安装字体解决。网络上提供的命令行方案是执行</p>
<figure class="hljs highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano <span class="regexp">/etc/</span>environment</span><br></pre></td></tr></table></figure>
<p>修改其中两行为：</p>
<blockquote>
<p>ARCH=arm64<br>LC_ALL=”en_US.utf-8″</p>
</blockquote>
<p>到这里，操作系统的配置差不多好了。……嗯，可以喝杯茶了。</p>
<p>我本来是想干什么来着？？</p>
<h3 id="准备交叉编译工具链"><a href="#准备交叉编译工具链" class="headerlink" title="准备交叉编译工具链"></a>准备交叉编译工具链</h3><p>假如选择交叉编译，除了直接apt install外，也可以<a href="http://releases.linaro.org/components/toolchain/binaries/" target="_blank" rel="noopener">去linaro网站</a>或者<a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain" target="_blank" rel="noopener">ARM官网</a>或者<a href="https://mirrors.tuna.tsinghua.edu.cn/armbian-releases/_toolchain/" target="_blank" rel="noopener">清华镜像源</a>下载交叉编译工具链。记得选择带有x86_64_arm(v8l)-linux-gnueabihf字样的。</p>
<p><a href="https://www.cnblogs.com/lixuejian/p/12848728.html" target="_blank" rel="noopener">复习下交叉编译器的命名规则</a>，为了可以在ARMV8、ARM64等同时兼容64位和32位的CPU的32位模式上运行，我们必须保证目标程序集是32位的，让CPU向下兼容。所以就算你用的是ARM CPU，只要系统架构不幸是AArch，也得用交叉编译工具链。</p>
<p>注意工具链里的armv8l指的armv8标准的32位模式。而64位模式的工具链的关键字是Aarch64。另外官网指出宿主架构必须是32位小端序（little endian），在这里也就是armel（或者叫做armle，全名是ARM eabi little-endian），不能是armeb。（不过工具链里面一般都是litle endian，除非特意标出是armeb。）</p>
<p>soft floating point还是hard floating point（Armhf）的话，最好选HF。</p>
<blockquote>
<p>用softfp模式，会存在不必要的浮点到整数、整数到浮点的转换。而使用hard模式，在每次浮点相关函数调用时，平均能节省20个CPU周期。对ARM这样每个周期都很重要的体系结构来说，这样的提升无疑是巨大的。对一些严重依赖于浮点运算的程序，更是可以达到300%的性能提升。</p>
</blockquote>
<p>我下载的包名是gcc-linaro-7.5.0-2019.12-x86_64_armv8l-linux-gnueabihf.tar.xz。</p>
<p>解压。</p>
<figure class="hljs highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">xz</span> <span class="selector-tag">-d</span> <span class="selector-tag">gcc-linaro-7</span><span class="selector-class">.5</span><span class="selector-class">.0-2019</span><span class="selector-class">.12-x86_64_armv8l-linux-gnueabihf</span><span class="selector-class">.tar</span><span class="selector-class">.xz</span></span><br></pre></td></tr></table></figure>
<p>安装到喜欢的目录。</p>
<figure class="hljs highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /usr/local/toochain</span><br><span class="line">sudo tar -xvf gcc-linaro<span class="number">-7.5</span><span class="number">.0</span><span class="number">-2019.12</span>-x86_64_armv8l-linux-gnueabihf.tar -C /usr/local/toolchain</span><br></pre></td></tr></table></figure>
<p>添加环境变量并刷新环境。</p>
<figure class="hljs highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PATH=<span class="variable">$PATH</span><span class="symbol">:/usr/local/toolchain/gcc-linaro-</span><span class="number">7.5</span>.0<span class="number">-2019.12</span>-x86_64_armv8l-linux-gnueabihf/bin</span><br><span class="line">source ~<span class="regexp">/.bashrc</span></span><br></pre></td></tr></table></figure>
<p>验证下是否能识别到编译器。</p>
<figure class="hljs highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">armv8l-linux-gnueabihf-gcc -v</span><br></pre></td></tr></table></figure>
<p>为什么我这么费劲要从镜像源手工装工具链，因为我发现这个傻屌银河麒麟10.1的默认的软件仓库里没有arm的编译工具链。</p>
<p>/etc/apt/sources.list 里面就一行</p>
 <figure class="hljs highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http:<span class="regexp">//</span>archive.kylinos.cn<span class="regexp">/kylin/</span>KYLIN-ALL <span class="number">10.1</span> main restricted universe multiverse</span><br></pre></td></tr></table></figure>
<p>我们看一下银河麒麟到底是什么玩意儿。</p>
<p><img src="//stgapr.github.io/post/galgame-on-ARM/kylin-is-debian.jpg" alt="麒麟就是补佳乐"></p>
<p>所以就是Debian 9 （ARM）对不对。内核还是在X86架构的Ubuntu用Linaro工具链交叉编译出来的。我们完全可以用Armbian （debian based）的软件仓库替换。（见上文）</p>
<h3 id="chroot和debootstrap"><a href="#chroot和debootstrap" class="headerlink" title="chroot和debootstrap"></a>chroot和debootstrap</h3><p>这种方法是通过切换rootfs来挂载一个32位环境。需要拉取一个32位的linux镜像，对于只是交叉编译而言，所以有点杀鸡用牛刀的感觉。本处参考了了网上的做法，不是特别理解所有步骤，请谨慎折腾。我不确定这种方法是不是要求处理器同架构。</p>
<p>从清华源拉一个32位的ubuntu 16.04（xenial）的镜像下来</p>
 <figure class="hljs highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p <span class="string">/srv/chroot/i386</span></span><br><span class="line">sudo apt-get install debootstrap</span><br><span class="line">sudo apt install schroot</span><br><span class="line">$ sudo debootstrap <span class="params">--foreign</span> <span class="params">--arch=i386</span> xenial <span class="string">/srv/chroot/i386</span> http:<span class="string">//mirrors.tuna.tsinghua.edu.cn/ubuntu/</span></span><br></pre></td></tr></table></figure>
<p>把本机的环境包抄到chroot的环境里</p>
<figure class="hljs highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot <span class="regexp">/srv/</span>chroot<span class="regexp">/i386/</span> <span class="regexp">/debootstrap/</span>debootstrap --second-stage</span><br></pre></td></tr></table></figure>
<p>然后修改一下/etc/schroot/schroot.d/ </p>
<p>添加</p>
<figure class="hljs highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[i386]</span></span><br><span class="line"><span class="attr">description</span>=Debian strectch armhf</span><br><span class="line"><span class="attr">directory</span>=/srv/chroot/i386</span><br><span class="line"><span class="comment">#aliases=test</span></span><br><span class="line"><span class="attr">type</span>=directory</span><br><span class="line"><span class="attr">root-users</span>=root</span><br><span class="line"><span class="attr">root-groups</span>=root</span><br><span class="line"><span class="attr">profile</span>=desktop</span><br><span class="line"><span class="attr">personality</span>=linux</span><br><span class="line"><span class="attr">preserve-environment</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">users</span>=（你的用户名）</span><br></pre></td></tr></table></figure>
<p>保存，退出来。切换进新的系统中。现在你已经在32位的Ubuntu里了。</p>
<figure class="hljs highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br><span class="line">schroot -<span class="keyword">c</span> chroot:<span class="keyword">i386</span></span><br></pre></td></tr></table></figure>
<p>添加一些语言支持和环境包</p>
<figure class="hljs highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt <span class="keyword">install</span> locales</span><br><span class="line">dpkg-reconfigure locales</span><br><span class="line">apt <span class="keyword">install</span> xfonts-wqy git wget zenity cabextract libcanberra-gtk-<span class="keyword">module</span> libcanberra-gtk* <span class="keyword">locate</span></span><br></pre></td></tr></table></figure>
<p>然后（只要不退出chroot进来的这个状态）就可以当成原生环境直接编译box86了。</p>
<h3 id="编译box86"><a href="#编译box86" class="headerlink" title="编译box86"></a>编译box86</h3><p>假设你已经配好了编译环境（不管是原生、chroot到32位还是用交叉工具链）</p>
<p>先把最新的box86代码拉下来。</p>
<figure class="hljs highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/ptitSeb/box86.git</span><br></pre></td></tr></table></figure>
<p>cmake。<br><figure class="hljs highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd box86; mkdir build; cd build; </span><br><span class="line">cmake <span class="built_in">..</span> <span class="attribute">-DARM_DYNAREC</span>=ON \</span><br><span class="line"><span class="attribute">-DCMAKE_BUILD_TYPE</span>=RelWithDebInfo \</span><br><span class="line"><span class="attribute">-DCMAKE_SYSTEM_PROCESSOR</span>=arm \</span><br><span class="line"><span class="attribute">-DCMAKE_C_COMPILER</span>=armv8l-linux-gnueabihf-gcc;</span><br></pre></td></tr></table></figure></p>
<p>注意-DCMAKE_C_COMPILER以指定编译器，交叉编译的时候不指定的话会出现平台参数错误。但是native编译可以不指定（其实也是指定的，官方都写在CMakeLists.txt里面）。</p>
<p>这里面有一个box86提供的选项叫做-DARM_DYNAREC。JIT / Dynarec / Hotspot之类的技术会把转换过的指令段缓存起来，有助于提高程序载入速度。这也是在CMakeLists.txt里面实现控制逻辑的。</p>
<blockquote>
<p>The Dynarec is only avaiable on ARM Cpu. Notes also that VFPv3 and NEON are required for the Dynarec. Activate it by using <code>-DARM_DYNAREC=1</code>. Also, be sure to use <code>-marm</code> in compilation flags (because many compileur use Thumb as default, and the dynarec will not work in this mode).</p>
</blockquote>
<p>box86特有的其他编译选项见<a href="https://github.com/ptitSeb/box86/blob/master/COMPILE.md" target="_blank" rel="noopener">COMPILE.md</a>。官方已经预置了一些硬件的编译参数（主要是CPU的型号差别）</p>
<p>此外也可以手动指定编译参数。假如你的目标设备没有在CMakeLists.txt里面add_definitions、 set(CMAKE_ASM_FLAGS=…)的话。自己的目标平台相关参数可以去网络上找。也可以参考 -gcc –target-help。</p>
<figure class="hljs highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CFLAGS</span>=<span class="string">"-march=armv8-a -mtune=cortex-a53"</span></span><br></pre></td></tr></table></figure>
<p>然后正式执行编译和链接。（后面的ARCH 、CROSS_COMPILE选项可以不要，假如你不是交叉编译）</p>
<figure class="hljs highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j8 <span class="attribute">ARCH</span>=arm <span class="attribute">CROSS_COMPILE</span>=armv8l-linux-gnueabihf-</span><br></pre></td></tr></table></figure>
<p>大概10秒钟就编译好了。在build目录下会生成box86（可执行文件）和libdynarec.a（库，假如你有开启dynarec选项），还有cmake生成的一堆没用的参数文件。之后我们需要把这两个文件拷贝到目标ARM机器上。</p>
<p>这时候我们确认一下程序的架构。切换到build目录下，运行</p>
<figure class="hljs highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">file</span> ./box86</span><br></pre></td></tr></table></figure>
<p>应该能看到类似</p>
<blockquote>
<p>ELF 32-bit LSB executable,ARM EABI5 version1 (SYSV), dynamically linked, interpreter…</p>
</blockquote>
<p>之类的信息。这说明这是一个Linux格式的可执行文件（ELF），32位，ARM架构。在编译的这台X86机器上该程序是执行不了的，它只能在ARM机器上执行。</p>
<h3 id="编译GL4ES（可选）"><a href="#编译GL4ES（可选）" class="headerlink" title="编译GL4ES（可选）"></a>编译GL4ES（可选）</h3><p>不少Windows程序用的是DirectX，Wine也自己用OpenGL实现了一遍DirectX API。但假如你用的是嵌入式设备，就是那些只支持OpenGLES的，就麻烦了。好在<a href="https://github.com/ptitSeb/gl4es" target="_blank" rel="noopener">GL4ES</a>提供了GLES硬件的OpenGL接口功能，类似做了一层wrap。只是GL4ES目前在Wine上面工作得不是很好。聊胜于无吧。这个项目也在积极开发中。</p>
<p>我们前面已经编译完那一堆看似最复杂的东西了。我在想为什么box86不用Github CI做自动构建……</p>
<p>现在该在ARM设备上通过box86和wine跑游戏了。这些部分也很刺激（但是要干的事情不少）。</p>
<h2 id="安装wine-x86"><a href="#安装wine-x86" class="headerlink" title="安装wine x86"></a>安装wine x86</h2><p>我们现在已经有可以跑在ARM上的box86了，还缺一个能被box86解释执行的X86版的wine。假如你的x86软件不需要调用Windows API（像是dos下面直接跑的那种游戏，可以完全不装wine）（不对啊，dos程序好像是16位的）（此处存疑）。</p>
<p>一般来说装wine是apt-get install一把梭，但这时候行不通。因为armbian是ARM架构的，直接安装只会安装到arm版的wine。而我们想要的是wine x86。 强行dpkg –add-architecture无法在ARM机器上添加i386 arhitecture。</p>
<p>ptitSeb/box86下面的issue也有很多人在问，官方<a href="https://github.com/ptitSeb/box86/blob/master/docs/X86WINE.md" target="_blank" rel="noopener">在README里给出了两个方法</a>，分别是</p>
<ul>
<li><p>从TwisterOS的仓库里拉取一份  （比较旧了）</p>
</li>
<li><p>从WineHQ官网上拿到deb包  （新，而且有不同分支可选）</p>
<p>然后都是解压（用tar或者dpkg）到某个目录，给/usr/bin软链接上去。利用wine wineboot命令初始化wine环境。另外再装一下winetricks（方便安装一些windows下面的运行库，比如.NET 之类）</p>
</li>
</ul>
<p>我重点说一下第二种方法，是去wine的官方仓库把wine x86的deb包下载下来，用dpkg强行安装。</p>
<p>比如基于Ubuntu 19.10（eoan）的Armbian为例，官方仓库网址是</p>
<p><a href="https://dl.winehq.org/wine-builds/**ubuntu**/dists/**eoan**/main/" target="_blank" rel="noopener">https://dl.winehq.org/wine-builds/**ubuntu**/dists/**eoan**/main/</a></p>
<p>有的Armbian是基于debian的，那么仓库就是wine-builds/<strong>debian</strong>/dists/<strong>xxxxx</strong>/main/</p>
<p>我们选择i386目录，进去发现wine的版本不少。建议选择wine开头（而不是winehq开头 <em>why？</em>）的，每个版本又依据开发分支分为前沿预览版（staging）、开发版（devel）、稳定版（stable），这些都在文件名开头标注。文件末尾的i386表示编译到X86_32。文件中间的dbg字样的是调试包，dev表示开发工具。我选择的是这个版本：</p>
<p>wine-stable-dbg_i386_5.0.1~stretch_i386.deb  </p>
<p>（那个stretch表示debian 9，是版本代号）</p>
<p>scp拷贝过去之后，在ARM机器上手动安装：</p>
<figure class="hljs highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">dpkg</span> <span class="selector-tag">-i</span> <span class="selector-tag">--force-architecture</span> <span class="selector-tag">wine-stable-dbg_i386_5</span><span class="selector-class">.0</span><span class="selector-class">.1</span>~<span class="selector-tag">stretch_i386</span><span class="selector-class">.deb</span></span><br></pre></td></tr></table></figure>
<p>假如提示一堆i386架构的依赖不满足的请在评论区里留言，我不确定是否可以通过以下方式强行把X86架构的依赖装上</p>
<figure class="hljs highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="keyword">add</span><span class="bash">-repository <span class="string">'deb [arch=i386] https://dl.winehq.org/wine-builds/debian/ strech main'</span></span></span><br></pre></td></tr></table></figure>
<p>此外，<a href="https://dl.winehq.org/wine-builds/debian/" target="_blank" rel="noopener">winehq的debian build 页面</a>上提到，wine x86的debian编译版由于开源许可授权问题，默认不包括 libfaudio0 。所以我们得自己添加这个库。</p>
<h2 id="运行windows-exe游戏"><a href="#运行windows-exe游戏" class="headerlink" title="运行windows exe游戏"></a>运行windows exe游戏</h2><p>假如你的ARM设备是笔记本，可以不用看。下面这些步骤适用于机顶盒等比较弱智的（不会自动挂载文件系统）的设备。</p>
<p>把游戏拷到外部存储设备上（比如移动硬盘），插入设备。然后查看可挂载的设备</p>
<figure class="hljs highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fdisk -l</span></span><br></pre></td></tr></table></figure>
<p>假定你看到自己的外部存储设备是/dev/sdb1，文件系统是NTFS</p>
<p>设置一个卷标方便记忆</p>
<figure class="hljs highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e2label <span class="regexp">/dev/</span>sdb1 mydisk</span><br></pre></td></tr></table></figure>
<p>把“将卷标为 mydisk的ntfs分区挂载到 /mnt 目录下”的这一条挂载命令——写入/etc/fstab，让每次开机时都能自动挂载：</p>
<figure class="hljs highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"LABEL=mydisk /mnt ntfs defaults,noatime,nofail 0 2"</span> &gt;&gt; <span class="string">/etc/fstab</span></span><br></pre></td></tr></table></figure>
<p>重启一下，应该就能看到挂载成功了。心急的话可以直接执行mount命令。armbian太不智能了。或者你是ARM笔记本的话，直接把拷贝有游戏的U盘插进去就完了。</p>
<p><br></p>
<p>然后终于可以运行游戏了。你猜它能跑得起来吗？</p>
<figure class="hljs highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> &lt;box86 folder&gt;</span><br><span class="line"><span class="string">./box86</span> wine <span class="string">/mnt/mydisk/</span>&lt;game folder&gt;<span class="string">/game.exe</span></span><br></pre></td></tr></table></figure>
<p> （自我排查一遍后，欢迎去box86项目的github issue下反映bug）</p>
<p>日文游戏不支持UTF-8的话，windows下是用Locale Emulator或Ntleas等转区工具。Linux下只需要在命令行前指定LC_ALL环境变量即可：</p>
<figure class="hljs highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LC_ALL=”ja_JP.utf-8″ <span class="string">./box86</span> wine <span class="string">/mnt/mydisk/</span>&lt;game folder&gt;<span class="string">/game.exe</span></span><br></pre></td></tr></table></figure>
<h3 id="一些优化配置"><a href="#一些优化配置" class="headerlink" title="一些优化配置"></a>一些优化配置</h3><h4 id="调节box86的按键映射（可选）"><a href="#调节box86的按键映射（可选）" class="headerlink" title="调节box86的按键映射（可选）"></a>调节box86的按键映射（可选）</h4><p>可以通过xmodap来映射按键，如</p>
<figure class="hljs highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">xmodmap</span> -e <span class="string">"keysym j=z"</span></span><br></pre></td></tr></table></figure>
<p>假如crash，运行此命令重置设定</p>
<figure class="hljs highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">setxkbmap</span></span><br></pre></td></tr></table></figure>
<p>有一些环境变量参数可以控制box86的行为，参见<a href="https://github.com/ptitSeb/box86/blob/master/docs/USAGE.md" target="_blank" rel="noopener">此处</a></p>
<h4 id="为GPU安装OpenGL-Mesa驱动（可选）"><a href="#为GPU安装OpenGL-Mesa驱动（可选）" class="headerlink" title="为GPU安装OpenGL Mesa驱动（可选）"></a>为GPU安装OpenGL Mesa驱动（可选）</h4><p>这一步是可选的，假如是系统剪裁过的嵌入式设备，用刚才那个GL4ES也能跑起3D图形。但假如可以装个原生的OpenGL库更好。</p>
<p>首先看一下OpenGL库的版本</p>
<figure class="hljs highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">glxinfo <span class="string">| grep "</span>OpenGL version<span class="string">"</span></span><br></pre></td></tr></table></figure>
<p>一般会显示“OpenGL version <strong>string</strong>: 3.0 Mesa xx.xx.xx“的字样。</p>
<p>网络上有篇文章（2019年8月写的）提到：</p>
<blockquote>
<p>如果默认使用apt安装的话，OpenGL则使用的是mesa18.3.6，在mesa19.1.x中整合了Lima Gallium3D驱动（Lima是针对ARM Mali系列GPU的一个逆向开源驱动，可以利用Mali的硬加速功能。）</p>
</blockquote>
<p>mesa是OpenGL规范的一个参考实现。假如你的GPU是Mali系列的，也可以拉取最新的mesa代码然后自己编译。</p>
<figure class="hljs highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/mesa3d/mesa.git</span><br><span class="line"><span class="keyword">cd</span> mesa</span><br><span class="line"><span class="built_in">mkdir</span> build$ <span class="keyword">cd</span> build</span><br><span class="line">$ meson ..</span><br><span class="line">$ sudo ninja install</span><br></pre></td></tr></table></figure>
<p>ok，wtf is “meson”， “ninja”？</p>
<p>现在的apt源应该已经有了支持Lima的mesa驱动。</p>
<h4 id="使用DS4游戏手柄（可选）"><a href="#使用DS4游戏手柄（可选）" class="headerlink" title="使用DS4游戏手柄（可选）"></a>使用DS4游戏手柄（可选）</h4><p>这也是锦上添花的事情。</p>
<p>Windows底下有一个开源软件叫做DS4Windows，逆向了DS4手柄的通信协议，并且包上XBOX 控制器的API，通过蓝牙在PC机上使用。我看了一下Linux下的类似项目DS4linux，发现上一个commit已经是好几年前的了（谁tm会在Linux下打游戏啊？SteamOS用户除外。）。不过还有一个2018年还在更新的项目叫做<a href="https://github.com/chrippa/ds4drv" target="_blank" rel="noopener">ds4drv</a>。我们装一下。</p>
<figure class="hljs highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> ds4drv</span><br></pre></td></tr></table></figure>
<p>安装完毕后执行  </p>
<figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ds4drv</span><br></pre></td></tr></table></figure>
<p>第一次配对，需要按住DS4手柄上的Share + PS按钮直到LED开始快速闪烁，连接上即可。</p>
<p>配置一下按键映射。我们这里自定义一个配置文件名字叫做ds4drv-gal.conf，不覆盖默认的ds4drv.conf</p>
<figure class="hljs highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano ~/.<span class="built_in">config</span>/ds4drv-gal.conf</span><br></pre></td></tr></table></figure>
<p>以下是个人对DS4手柄映射的喜好，适用于Galgame类游戏。</p>
<figure class="hljs highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">□：鼠标右键</span><br><span class="line">▲：PageUp</span><br><span class="line">×：Esc</span><br><span class="line">●：<span class="keyword">Enter</span></span><br><span class="line">↑：↑</span><br><span class="line">↓：↓</span><br><span class="line">←：音量-</span><br><span class="line">→：音量+</span><br><span class="line">左摇杆上下左右：鼠标上下左右移动</span><br><span class="line">右摇杆上下左右：↑↓←→</span><br><span class="line">L1 L2 <span class="built_in">R1</span> <span class="built_in">R2</span>：鼠标左键</span><br></pre></td></tr></table></figure>
<p>根据Linux定义的按键映射表，可以改一下<a href="https://github.com/chrippa/ds4drv/blob/master/ds4drv.conf" target="_blank" rel="noopener">官方示例</a>，做出一份gal专用的配置。注意，里面的[mapping:keyboard]项，等号左边是计算机外设的按键，右边是DS4的按键。</p>
<figure class="hljs highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ds4drv]</span></span><br><span class="line"><span class="attr">daemon</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">daemon-log</span> = ~/.cache/ds4drv.log</span><br><span class="line"><span class="attr">daemon-pid</span> = /tmp/ds4drv.pid</span><br><span class="line"></span><br><span class="line"><span class="section">[controller:1]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile:xpad]</span></span><br><span class="line"><span class="attr">led</span> = ff0000</span><br><span class="line"><span class="attr">emulate-xpad</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile:kbmouse]</span></span><br><span class="line"><span class="attr">led</span> = <span class="number">00</span>ff00</span><br><span class="line"><span class="attr">trackpad-mouse</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">mapping</span> = keyboard</span><br><span class="line"><span class="attr">bindings</span> = exec_stuff</span><br><span class="line"></span><br><span class="line"><span class="section">[mapping:keyboard]</span></span><br><span class="line"><span class="attr">KEY_UP</span> = dpad_up </span><br><span class="line"><span class="attr">KEY_LEFT</span> = dpad_left </span><br><span class="line"><span class="attr">KEY_DOWN</span> = dpad_down </span><br><span class="line"><span class="attr">KEY_RIGHT</span> = dpad_right</span><br><span class="line"><span class="attr">KEY_Z</span> = button_cross</span><br><span class="line"><span class="attr">KEY_X</span> = button_circle</span><br><span class="line"></span><br><span class="line"><span class="attr">KEY_W</span> = -left_analog_y</span><br><span class="line"><span class="attr">KEY_A</span> = -left_analog_x</span><br><span class="line"><span class="attr">KEY_S</span> = +left_analog_y</span><br><span class="line"><span class="attr">KEY_D</span> = +left_analog_x</span><br><span class="line"></span><br><span class="line"><span class="attr">REL_X</span> = right_analog_x</span><br><span class="line"><span class="attr">REL_Y</span> = right_analog_y</span><br><span class="line"></span><br><span class="line"><span class="attr">BTN_LEFT</span> = button_r2</span><br><span class="line"><span class="attr">BTN_RIGHT</span> = button_l2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">REL_WHEELUP</span> = button_l1</span><br><span class="line"><span class="attr">REL_WHEELDOWN</span> = button_r1</span><br></pre></td></tr></table></figure>
<p>然后我们还是让它在后台运行吧</p>
<figure class="hljs highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ds4drv--<span class="built_in">config</span> ~/.<span class="built_in">config</span>/ds4drv-gal.conf &amp;</span><br></pre></td></tr></table></figure>
<p>嫌麻烦的同学可以想办法把它写入init.d里面开机自动运行。</p>
<h3 id="故障排除"><a href="#故障排除" class="headerlink" title="故障排除"></a>故障排除</h3><p>运行的时候可能会提示缺少某些库，比如libstdc++，libgcc之类。可以从<a href="https://drive.google.com/file/d/1YmawY3TvJPCze7aHhtO1rrptJQ1pvzcp/view?usp=sharing" target="_blank" rel="noopener">这里</a>下载</p>
<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><p>（待补充）</p>

    </main>
    <footer class="post-footer">
      
      <div class="post-tags">
        
        <a class="post-tag button" href="/tags/技术/" rel="tag"><i class="fas fa-tags"></i>技术</a>
        
        <a class="post-tag button" href="/tags/X86/" rel="tag"><i class="fas fa-tags"></i>X86</a>
        
        <a class="post-tag button" href="/tags/ARM/" rel="tag"><i class="fas fa-tags"></i>ARM</a>
        
        <a class="post-tag button" href="/tags/仿真/" rel="tag"><i class="fas fa-tags"></i>仿真</a>
        
        <a class="post-tag button" href="/tags/wine/" rel="tag"><i class="fas fa-tags"></i>wine</a>
        
        <a class="post-tag button" href="/tags/box86/" rel="tag"><i class="fas fa-tags"></i>box86</a>
        
      </div>
      
    </footer>
  </article>
  
  
  <nav class="page-nav">
    <div class="page-nav-next page-nav-item">
      
      <a href="/post/tabi-deta/" rel="next" title="春の午後 僕は長い旅をした 2011 - 多田葵"><i class="fas fa-angle-left"></i><span class="nav-title">春の午後 僕は長い旅をした 2011 - 多田葵</span></a>
      
    </div>
    <div class="page-nav-prev page-nav-item">
      
    </div>
  </nav>
  
  
  

<div class="comments" id="comments">

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<div id="gitalk-container"></div>
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'fc5cc78006347ed7f2b8',
        clientSecret: 'eb4cc326feb2418f9add0833f57adbe9e423fb43',
        id: window.location.pathname,
        repo: 'lilis',
        owner: 'stgapr',
        admin: 'stgapr'
    })
    gitalk.render('gitalk-container')
</script>


</div>



  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="Search" class="form-control">
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/images/avatar.png" alt="Prism(walnuss)">
  
  <h1 class="author-name">Prism(walnuss)</h1>
  <h2 class="author-description"></h2>
  <div class="site-count">
    
    <div class="archives-count">
      <div class="site-count-title">Archives</div>
      <div><a href="/archives/">120</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="categories-count">
      <div class="site-count-title">Categories</div>
      <div><a href="/categories/">6</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="tags-count">
      <div class="site-count-title">Tags</div>
      <div><a href="/tags/">129</a></div>
    </div>
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    
    
    
    
    <hr>
    <div class="post-toc sidebar-item" id="toc-div">
      <div><i class="fas fa-list-ol"></i>Table of Contents</div>
      <div class="post-toc-content"><ol class="list-group toc"><li class="toc-item toc-level-1"><a class="list-group-item toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="list-group-item toc-link" href="#可行性和方案"><span class="toc-text">可行性和方案</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#hangover-和box86"><span class="toc-text">hangover 和box86</span></a></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#构建box86"><span class="toc-text">构建box86</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#关于ARM的架构"><span class="toc-text">关于ARM的架构</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#换软件源（可选）"><span class="toc-text">换软件源（可选）</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#准备交叉编译工具链"><span class="toc-text">准备交叉编译工具链</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#chroot和debootstrap"><span class="toc-text">chroot和debootstrap</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#编译box86"><span class="toc-text">编译box86</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#编译GL4ES（可选）"><span class="toc-text">编译GL4ES（可选）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#安装wine-x86"><span class="toc-text">安装wine x86</span></a></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#运行windows-exe游戏"><span class="toc-text">运行windows exe游戏</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#一些优化配置"><span class="toc-text">一些优化配置</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#调节box86的按键映射（可选）"><span class="toc-text">调节box86的按键映射（可选）</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#为GPU安装OpenGL-Mesa驱动（可选）"><span class="toc-text">为GPU安装OpenGL Mesa驱动（可选）</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#使用DS4游戏手柄（可选）"><span class="toc-text">使用DS4游戏手柄（可选）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#故障排除"><span class="toc-text">故障排除</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#性能测试"><span class="toc-text">性能测试</span></a></li></ol></li></ol></li></ol></div>
    </div>
    
    
    
    <hr>
    <div class="social-link sidebar-item">
      <div><i class="far fa-address-card"></i>Social Links<p></p></div>
      <ul>
        
        <li><i class="fas fa-envelope"></i><a href="mailto:stgapr29@gmail.com" target="_blank">Email</a></li>
        
        <li><i class="fab fa-github"></i><a href="https://github.com/stgapr" target="_blank">Github</a></li>
        
      </ul>
    </div>
    
    
    <hr>
    <div class="blogroll sidebar-item">
      <div><i class="fas fa-link"></i>Blogroll</div>
      <ul>
        
        <li><a href="https://yuukoamamiya.github.io/" target="_blank">雨宫优子</a></li>
        
        <li><a href="https://plumz.me/" target="_blank">plum</a></li>
        
        <li><a href="https://incises.github.io/" target="_blank">Incises</a></li>
        
        <li><a href="https://mistakey.top/" target="_blank">叶月辉夜</a></li>
        
        <li><a href="https://sh.alynx.moe" target="_blank">喵's StackHarbor</a></li>
        
        <li><a href="https://pockies.github.io/" target="_blank">Pockies</a></li>
        
        <li><a href="http://noodlefighter.com/" target="_blank">虾包</a></li>
        
        <li><a href="https://www.natech.top/" target="_blank">无聊人士的低语</a></li>
        
        <li><a href="https://miroox.github.io/" target="_blank">谜镜</a></li>
        
        <li><a href="https://linhai1990.com/" target="_blank">四海为家的兔子</a></li>
        
        <li><a href="https://touko.moe/" target="_blank">Touko</a></li>
        
        <li><a href="https://suzumiyashirone.github.io/" target="_blank">涼宮シロネ</a></li>
        
        <li><a href="https://www.gazyip.cn/" target="_blank">八个比特</a></li>
        
        <li><a href="https://qwonsuzune.wordpress.com/" target="_blank">沙子小房间</a></li>
        
        <li><a href="https://zankyo.cc/" target="_blank">青花鱼</a></li>
        
        <li><a href="https://blog.uuz.moe/" target="_blank">雨宮千夏の博麗神社</a></li>
        
        <li><a href="https://luojia.me/" target="_blank">佳佳酱</a></li>
        
        <li><a href="https://lnet.me/" target="_blank">澜灯</a></li>
        
        <li><a href="https://taoxinhao.cn/" target="_blank">陶新昊</a></li>
        
        <li><a href="https://www.wikimoe.com/" target="_blank">WIKIMOE</a></li>
        
        <li><a href="http://www.misakas.com/" target="_blank">misakas</a></li>
        
        <li><a href="https://blog.ixk.me/" target="_blank">ixk.me</a></li>
        
        <li><a href="http://blog.dangodango.cn/" target="_blank">团子的小小世界</a></li>
        
        <li><a href="http://blog.9bie.org:8081/" target="_blank">⑨bie</a></li>
        
        <li><a href="https://utsuho.cn/" target="_blank">喵の空</a></li>
        
        <li><a href="https://www.rabbittu.com/" target="_blank">某兔子の御用花园</a></li>
        
        <li><a href="http://pea3nut.info/" target="_blank">花生PeA</a></li>
        
        <li><a href="http://www.iinorii.com/blog/" target="_blank">いつの間に</a></li>
        
        <li><a href="https://www.senayuki.top/" target="_blank">纷飞的小屋</a></li>
        
        <li><a href="http://whitebox.im/" target="_blank">白色箱子</a></li>
        
        <li><a href="http://code5light.com/" target="_blank">多事之秋</a></li>
        
        <li><a href="https://diygod.me/friends/" target="_blank">DIYGOD</a></li>
        
        <li><a href="https://ephen.me/" target="_blank">Ephen</a></li>
        
        <li><a href="https://ikk.me/" target="_blank">ikk.me</a></li>
        
        <li><a href="https://ikmoe.com/" target="_blank">月宅酱</a></li>
        
        <li><a href="https://www.rexskz.info/" target="_blank">ReX/Zeng</a></li>
        
        <li><a href="https://2heng.xin/" target="_blank">さくら荘の白猫</a></li>
        
        <li><a href="https://www.fczbl.vip/" target="_blank">犬's blog</a></li>
        
        <li><a href="https://aoaoao.me/" target="_blank">Aaron</a></li>
        
        <li><a href="https://blog.0xbbc.com/" target="_blank">3004</a></li>
        
        <li><a href="http://mouto.org/" target="_blank">卜卜口</a></li>
        
        <li><a href="https://wind.moe/links/" target="_blank">Windless</a></li>
        
        <li><a href="https://oao.moe/links/" target="_blank">oao</a></li>
        
        <li><a href="http://im.dimpurr.com/" target="_blank">钉子の次元</a></li>
        
        <li><a href="http://acgtyrant.com/" target="_blank">acgtyrant</a></li>
        
        <li><a href="https://asaba.sakuragawa.moe/" target="_blank">樱川浅羽</a></li>
        
        <li><a href="https://buta.moe/" target="_blank">Take Space</a></li>
        
        <li><a href="http://takumiyuki.hatenablog.com/" target="_blank">TakumiYuki</a></li>
        
        <li><a href="https://flandre-scarlet.moe/blog/" target="_blank">Re:memory</a></li>
        
      </ul>
    </div>
    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="Back to Top"></i></button>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">Prism(walnuss)</span><span class="year"><i class="far fa-copyright"></i>1994 - 2021</span>
        </div>
        
        <div class="busuanzi">
          <span id="busuanzi_container_site_pv"><i class="fas fa-eye" aria-label="Site Visit Count" aria-hidden="false"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user" aria-label="Site User Count" aria-hidden="false"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv" aria-label="Page Click Count" aria-hidden="false"></span></span>
        </div>
        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          您所关注的博主已经获得了心灵的宁静~
          
        </div>
        <div class="powered-by">
          Proudly Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> | Theme is <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
